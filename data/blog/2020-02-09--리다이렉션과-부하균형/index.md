---
title: 리다이렉션과 부하균형
createdDate: "2020-02-09"
updatedDate: "2020-02-09"
author: Ideveloper
tags:
  - network
image: redirection.png
draft: false
---

`이 글은 HTTP 완벽가이드 19장을 참고해 정리한 포스팅입니다.`

## 시작하기에 앞서

- HTTP 메시지의 데이터는 네트워크 통신과정에서 많은 프로토콜에 의해 통제됩니다.
- HTTP가 고려하는 것은 오직 출발지(송신자)와 목적지(수신자) 뿐이지만, 미러링된 서버, 웹 프락시, 캐시 등 역시도 고려되어야 하므로 항상 단순하지만은 않습니다.
- 리다이렉션 기술은 HTTP 메시지의 최종 목적지를 정하는것과 관련되어있고, 보통 메시지가 프락시,캐시, 서버팜의 특정 웹서버 중 어디에서 끝나는지 판별하기 위해 사용한다고 합니다.
- 리다이렉션 기술은 클라이언트의 메시지를 명시적으로 요청하지 않은 곳으로 보낼 수 있습니다.

---

## 리다이렉션을 하는 이유

HTTP 애플리케이션은 언제나 아래 세가지를 원하기 때문에 리다이렉션은 현대의 웹에서는 불가피합니다.

- 신뢰할 수 있는 HTTP 트랜잭션의 수행
- 지연 최소화
- 네트워크 대역폭 절약

위와 같은 이유들 때문에, 웹 콘텐츠는 흔히 여러장소에 배포하게 됩니다.

- 이렇게 하면 한곳에서 실패한 경우 다른 곳을 이용할 수 있으므로 `신뢰성` 이 개선됩니다.
- 또한 클라이언트가 보다 가까운 리소스에 접근할 수 있게 되어 `응답시간`도 줄여줍니다.
- 또한 목적지 서버가 분산되므로 `네트워크 혼잡도`도 줄어들게 됩니다.

**이렇게 리다이렉션이란 최적의 분산된 콘텐츠를 찾는 것을 도와주는 기법의 집합이라고 할 수 있습니다.**

리다이렉션 구현에는 load-balancing(부하 균형)의 과제가 포함되는데, 왜냐하면 둘은 서로 공존하기 떄문입니다.(대부분의 리다이렉션 장치들은 몇가지 방식의 부하 균형을 포함)

---

## 리다이렉션이 필요한 곳

- 서버, 프락시, 캐시, 게이트웨이가 모두 공통적으로 서버의 특성을 가지고 있기 때문에 많은 리다이렉션 기법이 그들 모두에서 동작하게 됩니다.
- 그러나 어떤 리다이렉션 기술들은 특정 종류의 종단 만을 위해 특별히 설계되어 일반적인 적용이 불가능합니다.
- 복제된 서버들로 요청을 분산한다는 것은 같은 URL에 대해 여러 곳에서 온 요청들을 각각 최적의 웹 서버로 보내겠다는 것(클라이언트에 가장 가까운 것이나 부하가 가장 적은 것, 혹은 그외의 이유로 최적인 것)을 의미하게 됩니다.
- 프락시는 프로토콜별로 요청을 다루게 됩니다. 클라이언트 근처에 프락시 캐시가 있다면, 모든 요청이 프락시 캐시로 흘러 들어가는 것이 이상적입니다. 프락시로의 리다이렉트는 주 진입로의 트래픽을 지름길로 보내는것과 같습니다.

---

## 리다이렉션 프로토콜의 개요

리다이렉션의 목표는 HTTP 메시지를 가용한 웹서버로 가급적 빨리 보내는 것입니다. HTTP 메시지가 인터넷을 통해 그 요청이 나아가는 방향은 HTTP 애플리케이션과 라우팅 장치에 영향을 받게 됩니다. 그 예들은 아래와 같습니다.

- 브라우저 애플리케이션의 사용자는 브라우저가 클라이언트 메시지를 프락시 서버로 보내도록 설정 할 수 있습니다.
- DNS 분석자는 메시지의 주소를 지정할때 사용될 IP 주소를 선택하게 되는데, 클라이언트의 지리적 위치에 따라 달라질 수 있습니다.
- 메시지는 주소가 지정된 여러 개의 패킷으로 나뉘어 네트워크를 통과하게 됩니다. 스위치와 라우터들은 패킷의 TCP/IP 주소를 검증하고 그에 근거하여 패킷을 어떻게 라우팅할 것인지 결정하게 됩니다.
- 웹 서버는 HTTP 리다이렉트를 이용해 요청이 다른 웹 서버로 가도록 할 수 있습니다.

위에서 설명한 `브라우저 설정`, `DNS`, `TCP/IP 라우팅`, 그리고 `HTTP`는 모두 메시지를 리다이렉트 하는 메커니즘을 제공합니다.

- 주의할 사항은 DNS 리다이렉션을 비롯한 대부분의 기법들이 트래픽을 보내려는 곳이 어떤 서버냐에 상관없이 사용될 수 있는 것에 반해 `브라우저 설정`과 같은 방법은 **프락시로 향하는 리다이렉트 트래픽**에서만 사용할 수 있다는 점을 유의해야 합니다.

---

## 리다이렉션 방법

#### 메시지를 서버로 리다이렉트 하기 위해 사용되는 리다이렉션 방법

| 메커니즘              |                                                     어떻게 동작하는가                                                      |                        재 라우팅의 근거                        |                                                                                                                                             제약사항 |
| :-------------------- | :------------------------------------------------------------------------------------------------------------------------: | :------------------------------------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------------: |
| HTTP 리다이렉션       |                   웹 서버는 콘텐츠를 제공하기에 최적인 웹 서버로의 redirect를 클라이언트에게 보내줍니다.                   | 라운드 로빈 부하 균형, 회전 지연 최소화, 최단 거리 선정, ..etc |                          느릴수 있고, 모든 트랜잭션이 추가 리다이렉트 단계를 포함하게 됩니다.또한 첫번째 웹서버가 요청 부하를 다룰 수 있어야 합니다. |
| DNS 리다이렉션        |                       DNS 서버가 URL의 호스트명에 대한 응답으로 어떤 IP 주소를 사용할지 결정합니다.                        | 라운드 로빈 부하 균형, 회전 지연 최소화, 최단 거리 선정, ..etc |                                                                                                                   DNS 서버를 설정할 필요가 있습니다. |
| 임의 캐스트 어드레싱  |          여러서버가 같은 IP주소를 사용. 그 외의 라우터들은 공유된 IP주소로 향하는 패킷을 가장 가까운 서버로 보냄           |         라우터들은 내장된 최단거리 라우티 기능을 사용          | 라우터를 설정할 필요 있음, 주소가 충돌할 위험이 있음.라우팅이 바뀌고 커넥션과 연관된 패킷들이 다른 서버들로 보내진다면 TCP 커넥션이 깨질수 있습니다. |
| 아이피 맥(MAC) 포워딩 |              패킷이 리다이렉트 되어야 한다면, 스위치는 그 패킷에게 서버나 프락시의 목적지 MAC 주소를 줍니다.               |   대역폭을 절약하고 서비스 품질을 개선합니다. load balancing   |                                                                                                   서버나 프록시는 반드시 한 홉 거리에 있어야 합니다. |
| IP 주소 포워딩        | 레이어 4(L4)스위치는 패킷의 목적지 포트를 평가하고, 리다이렉트 패킷의 IP주소를 프락시나 미러링된 서버의 IP주소로 바꿉니다. |   대역폭을 절약하고 서비스 품질을 개선합니다. load balancing   |                                                                                          서버나 프락시가 클라이언트의 IP주소를 잃어버릴 수 있습니다. |

#### 메시지를 프락시 서버로 리다이렉트하기 위해 사용되는 리다이렉션 방법

| 메커니즘                    |                                                              어떻게 동작하는가                                                               |                                재라우팅의 근거                                 | 제약사항                                                                                                                                                      |
| :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 명시적인 브라우저 설정      |                                웹 브라우저는 가까운 프락시(보통 캐시)에게 HTTP 메시지를 보내도록 설정됩니다.                                 |                      대역폭을 절약하고 QOS 개선, 부하균형                      | 브라우저의 설정 능력에 의존                                                                                                                                   |
| 프록시 자동 설정            |      웹브라우저는 설정 서버로부터 PAC 파일을 검색, PAC 파일은 브라우저에게 각 url에 대해 어떤 프락시를 사용해야 하는지 알려주게 됩니다.      |                      대역폭을 절약하고 QOS 개선, 부하균형                      | 브라우저의 설정 능력에 의존                                                                                                                                   | 브라우저는 반드시 설정된 서버로 질의를 보내도록 설정되어있어야 합니다. |
| 웹 프락시 자동발견 프로토콜 | 웹브라우저는 설정 서버에게 PAC파일에 대한 URL을 물어봅니다. PAC만 사용할때와 달리 브라우저에 특정 설정 서버가 설정되어야 할 필요가 없습니다. | 설정 서버는 HTTP 요청헤더에서 얻은 정보에 근거해 PAC 파일의 URL을 결정합니다.  |                                                                                                                                                               |
| 웹 캐시 조직 프로토콜       |                라우터는 패킷의 목적지 주소를 평가하고 프락시나 미러링된 서버의 IP주소와 함께 리다이렉트 패킷을 캡슐화합니다.                 |             대역폭을 절약하고 QOS를 개선, 부하균형(Load balancing)             | 반드시 이를 지원하는 브라우저를 사용해야 함                                                                                                                   |
| 인터넷 캐시 프로토콜        |                       프락시 캐시는 형제 캐시의 무리에게 요청받은 콘텐츠에 대해 질의 할 수있고, 캐시계층을 지원합니다.                       | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는 것은 원서버로부터 얻는것보다 빠릅니다. | 콘텐츠를 요청할때 오직 URL만을 사용하기 때문에 캐시 적중이 아님에도 적중인것처럼 동작할 우려가 있음.                                                          |
| 캐시 배열 라우팅 프로토콜   |                                   프락시 캐시 해싱 프로토콜. 캐시가 요청을 부모캐시로 전달할수 있도록 해줌                                   | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는 것은 원서버로부터 얻는것보다 빠릅니다. | 형제 관계의 캐시를 지원할수 없음. 모든 CARP 클라이언트는 반드시 설정에 동의해야함(그렇지 않으면 같은 URI를 다른 부모에게 되어 캐시 적중률 감소할 가능성 높음) |
| 하이퍼텍스트 캐싱 프로토콜  |                              참여하는 프록시 캐시는 형제 캐시의 무리에게 요청받은 콘텐츠에 대해 질의할수 있음.                               | 형제 혹은 부모 캐시로부터 콘텐츠를 얻는 것은 원서버로부터 얻는것보다 빠릅니다. |                                                                                                                                                               |

## 추가로 읽어보면 좋을 링크

- 로드밸런싱 관련 글: https://nesoy.github.io/articles/2018-06/Load-Balancer
- L4 로드밸런싱: https://jins-dev.tistory.com/entry/L4-L7-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1Load-Balancing-%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC
- DNS 리다이렉션을 악용한 사례: https://www.boannews.com/media/view.asp?idx=45231&direct=mobile
